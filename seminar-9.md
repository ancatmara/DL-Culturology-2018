## Сетевой анализ. Работа с Gephi.

#### Что такое граф? {#что-такое-граф}

**Граф, или сеть **– это модель, состоящая из **узлов **и связей между ними, или **ребер**. По-английски это называется _nodes \(vertices\) _и _edges_.

![](https://ancatmara.gitbooks.io/digital-literacy/content/assets/graph_1.png)

Узлы в графах могут группироваться в сообщества. **Сообщество** – это плотный подграф, где все \(или почти все\) узлы связаны между собой. Графы бывают:

* ориентированные и неориентированные \(связи-стрелочки vs обычные связи\)
* связные и несвязные \(все узлы связаны vs есть узлы, которые оторваны от основного графа\).
* взвешенные и невзвешенные \(связи имеют некоторое числовое значение или нет\)

В лекции вы видели много разнообразных примеров графов, вот еще один. Здесь станции – это узлы, а перегоны – ребра. Когда вы рассчитываете расстояние в пути, вы работаете со взвешенным графом: каждый перегон оценивается в несколько минут.

![](/assets/fdsdzimport.png)

А вот так выглядит интернет!

![](https://ancatmara.gitbooks.io/digital-literacy/content/assets/rsz_internet_network.png)

А вот так выглядит алгоритм машинного обучения

![](/assets/tyijimport.png)

#### Метрики {#метрики}

**Метрика** – это результат измерений, проведенных определенным способом. Представьте, что вы выбираете материал для реферата на тему "Слово о полку Игореве": у вас есть оригинальный текст в 50 страниц, современная книга А.А. Зализняка "Слово о полку Игореве: взгляд лингвиста" в 500 страниц и англоязычная статья "The Igor Tales and Their Folkloric Background" в 100 страниц. Если метрикой для вас является количество страниц, то вы выберете оригинальный текст, а если простота чтения – то современную русскоязычную книжку.

**Степень, или мощность узла **_\(degree\) _– это количество его связей.

**Взвешенная степень **_\(weighed degree\) _– это количество связей узла, разделенное на общее количество связей в графе.

Важность узла можно определять разными способами:

* **degree centrality**: у кого больше связей, тот и важнее
* **closeness centrality**: чем центральнее узел \(т.е. чем короче путь от него до всех остальных узлов\), тем он важнее
* **betweenness centrality**: количество кратчайших путей, проходящих через узел
* **eigencentrality**: чем больше друзей у твоих друзей, тем ты важнее

**Коэффициент ассортативности **_\(assortativity coefficient\) _определяет, с кем связаны "важные" узлы: если с другими "важными" узлами, то значение коэффициента высокое, а если нет – низкое.

**Коэффициент кластеризации **_\(clustering coefficient\) – _степень взаимодействия между собой ближайших соседей узла, т.е. вероятность того, что ближайшие соседи узла будут связаны не только с ним, но и между собой.

**Плотность графа **_\(density\) – _отношение числа ребер к максимально возможному. В сообществах высокий коэффициент кластеризации и высокая плотность.

**Модулярность **_\(modularity\) _показывает, насколько при заданном разбиении графа на группы плотность связей внутри группы больше плотности связей между группами. С помощью этой метрики граф разбивается на сообщества.

#### Форматы графов {#форматы-графов}

Граф записывается в виде текстового \(.gml\) или XML-файла \(.graphml, .gexf\), где перечисляются все узлы, ребра и их атрибуты – например, название узла или вес ребра. Вот так выглядят файлы .gml и .gexf соответственно.

![](https://ancatmara.gitbooks.io/digital-literacy/content/assets/grapg6.png)

![](https://ancatmara.gitbooks.io/digital-literacy/content/assets/graph7.png)

#### Gephi {#gephi}

**Gephi** – программа для визуализации графов. Скачать ее можно [отсюда](https://gephi.org/), а [вот здесь](https://gephi.org/users/) инструкция по работе с ней.

С помощью Gephi можно делать очень красивые и наглядные картинки. Вот пример из работы польского специалиста по стилометрии Яна Рыбицки – хронология романов Ч. Диккенса, построенная по наиболее частотным словам в тексте.

![](https://ancatmara.gitbooks.io/digital-literacy/content/assets/image2.png)

А это граф русских романов XIX века от команды тьюториала по стилометрии на II московско-тартусской школе по Digital Humanities.

![](https://ancatmara.gitbooks.io/digital-literacy/content/assets/import1111.png)

Графы, созданные в Gephi, можно не только сохранять как картинки или pdf, но и публиковать в интернете \(например, на GitHub\) с помощью плагина Sigma. Вот [пример интерактивного графа](https://yosej.github.io/Ossian_Full_Network/) по Оссиановским поэмам Макферсона.

А теперь давайте разберемся, как всё это это сделать.

#### Работа с графом в Gephi {#работа-с-графом-в-gephi}

Мы будем работать с контактами внутри сообщества дельфинов-[афалин](https://en.wikipedia.org/wiki/Bottlenose_dolphin). [Здесь](https://drive.google.com/file/d/1Jkv62MyuPmkfvP4h9bTYzq73IwVOH1OT/view) можно скачать данные \(в gephi можно загружать файлы не только в формате .gml, .graphml, .gexf, но и в табличных форматах \(.csv, .tsv,\). [Здесь](https://gephi.org/users/supported-graph-formats/) есть подробный разбор этого. При запуске программы появляется приветственное окошко.

![](https://ancatmara.gitbooks.io/digital-literacy/content/assets/gephi_1.png)

Нажимаем _Создать новый проект_, затем _Файл_ → _Import Spreadsheet_. Выбираем файл out.dolphins.tsv → _Open_ \(Параметры: Separator:Tab Import As:Edges Table, остальные не меняем\).

Если вы импортируете файл с графом, то после импорта Gephi покажет отчет с характеристиками графа, а также количеством узлов и ребер.

Сразу после загрузки граф будет выглядеть вот так.

![](/assets/ouilkimport.png)

Gephi позволяет вручную менять размер, цвет и подписи узлов и рёбер. Для этого нужно использовать панель инструментов слева от графа. Кроме того, узлы можно перетаскивать мышкой.

Чтобы сделать его более наглядным, можно настроить свет и размер узлов и ребер в соответствии с их атрибутами.

Начнём с того, что изменим размер узлов в зависимости от их степени, для этого в разделе Appearance нажмём _Nodes_ и значок размера.

![](/assets/opouiyimport.png)

После чего выберем _Ranking_ → Degree. Затем _Применить_. Чем больше разброс между минимальным и максимальным значением, тем наглядней получается граф. Может получится, например, так:

![](/assets/pppimport.png)

Следующим шагом посчитаем модулярность, чтобы разбить наш граф на сообщества. Это делается во вкладке «Статистика» на рабочей панели справа.

![](https://ancatmara.gitbooks.io/digital-literacy/content/assets/gephi4.png)

Теперь перейдем к изменению цвета узлов и ребер. Это делается с помощью значка палитры во вкладке «Appearance» на левой рабочей панели. По умолчанию все узлы и ребра раскрашены одним цветом \(Unique\), но мы раскрасим их в соответствии с тем, к каким сообществам они принадлежат \(Partition → Modularity Class\).

![](https://ancatmara.gitbooks.io/digital-literacy/content/assets/gephi5.png)

В правом нижнем углу вы увидите маленькую надпись Palette – нажав на нее, можно выбрать цвета, в которые будут раскрашены узлы. В палитрах по умолчанию всего 8 цветов, для больших графов нужно больше. Для таких случаев в Gephi предусмотрена возможность сгенерировать палитру: чтобы цветов было столько, сколько разных значений у выбранного атрибута, нужно просто снять галочку с «Limit number of colours», а затем нажать Generate и OK. Можно также выбрать стиль палитры \(параметр Presets\): пастельные тона, темные цвета, насыщенные цвета и т.п.

![](https://ancatmara.gitbooks.io/digital-literacy/content/assets/gephi7.png)

После этих манипуляций получится примерно такая картина. Управлять масштабом графа можно с помощью колеса мыши, а кнопка с лупой в нижней части панели инструментов слева от рабочей области центрирует граф.

![](/assets/poiuiimport.png)

По умолчанию граф уложен случайным образом – то есть то, где располагается узел и какие узлы находятся рядом с ним, ничего не значит. Попробуем сделать картинку более осмысленной с помощью какого-нибудь алгоритма укладки. Меню «Укладка» находится в левом нижнем углу. Вот, например, алгоритм Fruchterman Reingold, который укладывает узлы по кругу \(обратите внимание, как узлы одного цвета, принадлежащие к одному сообществу, притянулись друг к другу\).

![](/assets/Снимок экрана 2018-04-13 в 2.35.35.png)

Кстати, необязательно ждать, пока укладка закончится \(спойлер: [она может идти вечно](https://www.dropbox.com/s/ek84sjxsanm1rda/force_layout.mp4?dl=0)\) -- если результат вас устраивает, можно просто нажать _Стоп_. Если вам кажется, что узлы расположены слишком тесно, можно использовать «Расширение» \(Expand\). Если вам кажется, что граф вверх ногами, то можно использовать «Поворот» \(Rotate\)

Выберите самую репрезентативную, на ваш взгляд, укладку. Может получиться так:

![](/assets/piuhjl;import.png)

Кроме того, вы можете захотеть добавить подписи узлов \(они называются **метками**, или _labels_\). Для работы с ними предусмотрена панель инструментов снизу от области с графом. Чтобы подписи появились, нужно нажать на черную букву Т; правее можно выбрать цвет, шрифт и кегль \(в этом датасете подписей нет, но вообще это может пригодиться\).

**NB! **В Gephi нет кнопки "Назад", так что будьте осторожны с изменениями, чтобы потом не пришлось все переделывать с самого начала.

Далее приводится другой пример графа: естественно, такие же манипуляции можно проводить и с любым другим.

![](https://ancatmara.gitbooks.io/digital-literacy/content/assets/gephi12.png)

После включения меток вы скорее всего столкнетесь с тем, что они наползают друг на друга. Чтобы этого избежать, нужно запустить алгоритм "Укладка меток". Картинки ниже – до и после укладки.

![](https://ancatmara.gitbooks.io/digital-literacy/content/assets/gephi13.png)

![](https://ancatmara.gitbooks.io/digital-literacy/content/assets/gephi14.png)

Все это время мы находились во вкладке "Обработка". Следующая вкладка, "Лаборатория данных", позволяет нам посмотреть на данные в табличном виде, добавить или удалить столбцы и строки, отредактировать или отфильтровать их с помощью регулярных выражений и экспортировать данные в csv \(или, наоборот, импортировать их из него, что очень удобно\).

![](https://ancatmara.gitbooks.io/digital-literacy/content/assets/gephi15.png)

Наконец, в последней вкладке, "Просмотр", можно увидеть красиво отрисованный граф, а не рабочую версию. Единственное что – отображение меток придется включить заново, но уже в этой вкладке на панели инструментов слева. Если у вас большой граф, то лучше снять галочку с параметра "Пропорциональный размер" и немного увеличить шрифт. Остальные параметры подписей можно настроить по своему вкусу.

![](https://ancatmara.gitbooks.io/digital-literacy/content/assets/gephi17.png)

Скорее всего, сначала вы увидите просто белое поле без графа – чтобы он отрисовался, нужно нажать кнопку "Обновить" внизу. То же самое нужно делать после любых изменений, если вы хотите их увидеть. Мой граф в итоге выглядит вот так.

![](https://ancatmara.gitbooks.io/digital-literacy/content/assets/gephi16.png)

Он достаточно хорошо интерпретируется:

* темно-зеленые узлы – это однокурсники из Вышки
* светло-зеленые узлы – это однокурсники из МГУ
* розовые узлы – это разные лингвисты \(преподаватели Вышки, студенты Вышки не с моего курса, студенты ОТиПЛа МГУ\)
* бирюзовые узлы – это друзья из МГУ курсом старше
* голубые узлы – это разные кельтологи и скандинависты
* бордовые узлы – это однокурсники из СПбГУ
* оранжевые узлы – это люди из родного города
* темно-фиолетовые узлы – это коллеги по работе
* светло-сиреневые узлы – это коллеги по походам
* желтые узлы – московские друзья

#### Экспорт графа {#экспорт-графа}

Граф можно сохранить в png или в pdf: если вам нужен небольшой файл и не важна детальность, то лучше выбрать png, а если вы хотите рассматривать граф при каком угодно приближении без потери качества, то лучше выбрать pdf. Экспортировать граф можно двумя способами: с помощью соответствующей кнопки в левом нижнем углу в "Просмотре" или в меню "Файл &gt; Экспорт".

![](https://ancatmara.gitbooks.io/digital-literacy/content/assets/gephi19.png)

Кроме того, можно экспортировать не статичную картинку, а динамический граф и выложить его в интернет – как исследование поэм Макферсона, помните? Для этого нужно установить плагин **Sigma Exporter **в меню "Сервис &gt; Подключаемые модули &gt; Доступные подключаемые модули" и перезагрузить Gephi. Не забудьте сохранить ваш проект \("Файл &gt; Сохранить проект", или Ctrl + S\) перед перезагрузкой, чтобы не потерять работу!

![](https://ancatmara.gitbooks.io/digital-literacy/content/assets/gephi20.png)

После этого можно сохранять граф в Sigma \("Файл &gt; Экспорт &gt; Sigma.js template"\).

![](https://ancatmara.gitbooks.io/digital-literacy/content/assets/gephi21.png)

В появившемся окне нужно указать путь к папке, куда вы хотите экспортировать проект, и данные для легенды: название и кратое описание графа, а также то, что обозначают узлы, ребра и их цвета.

![](https://ancatmara.gitbooks.io/digital-literacy/content/assets/gephi22png.png)

После этого в указанной директории появится папка network. Все файлы из этой папки нужно загрузить в новый репозиторий на гитхабе. Если вы забыли что-то указать при экспорте, это можно будет поправить в файле config.json вручную, открыв его в блокноте. Вот список файлов, который должен оказаться в вашем репозитории.

![](https://ancatmara.gitbooks.io/digital-literacy/content/assets/gh.png)

Теперь, когда все нужные файлы лежат в репозитории, отправляемся в его настройки и прокручиваем их вниз до пункта GitHub Pages, а затем в Source выбираем Master branch и нажимаем кнопку Save. У вас должно появиться зеленое уведомление с адресом вашей странички формата

`https://username.github.io/repository_name`

![](https://ancatmara.gitbooks.io/digital-literacy/content/assets/gh771.png)

![](https://ancatmara.gitbooks.io/digital-literacy/content/assets/gh677.png)

Получиться должно что-то вот такое. Если хотите, можете поэкспериментировать с файлом index.html, чтобы избавиться от элементов, которые вам не нравятся \(например, от пустого поля в верхней части легенды\).

![](https://ancatmara.gitbooks.io/digital-literacy/content/assets/gh6-0-.png)

Обратите внимание, что все селекторы должны работать!

![](https://ancatmara.gitbooks.io/digital-literacy/content/assets/gh556.png)

![](https://ancatmara.gitbooks.io/digital-literacy/content/assets/пр7890-.png)

![](https://ancatmara.gitbooks.io/digital-literacy/content/assets/gh888798.png)

##### Полезная ссылка

[Туториал](https://seinecle.github.io/gephi-tutorials/)

